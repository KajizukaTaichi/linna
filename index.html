<!doctype html>
<html lang="en">
    <head>
        <title>Linna: code editor that doesn't make you anger</title>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css"
        />
    </head>

    <body>
        <p class="title">Linna</p>
        <p class="subtitle">code editor that doesn't make you anger</p>
        <hr class="has-background-grey-lighter" />
        <div id="editor"></div>
    </body>

    <script>
        let buffer = "";
        let cursor = 0;
        let history = [];

        function insertString(originalString, index, stringToInsert) {
            return (
                originalString.slice(0, index) +
                stringToInsert +
                originalString.slice(index)
            );
        }

        function removeCharAtIndex(str, index) {
            return str.slice(0, index) + str.slice(index + 1);
        }

        function updateEditor() {
            let show = insertString(buffer, cursor, "|");
            let editor = document.getElementById("editor");
            editor.textContent = "";

            let n = 1;
            for (line of show.split("\n")) {
                let elm = document.createElement("pre");
                elm.className = "line";
                elm.innerText =
                    String(n).padStart(
                        String(show.split("\n").length).length + 1,
                        " ",
                    ) +
                    "  " +
                    (line == "" ? " " : line);
                editor.appendChild(elm);
                n++;
            }
        }

        document.addEventListener("keydown", function (event) {
            event.preventDefault();

            let is_back = false;
            if (event.code === "ArrowLeft") {
                cursor -= 1;
            } else if (event.code === "ArrowRight") {
                cursor += 1;
            } else if (
                event.code === "ArrowUp" &&
                event.ctrlKey | event.metaKey
            ) {
                cursor = 0;
            } else if (
                event.code === "ArrowDown" &&
                event.ctrlKey | event.metaKey
            ) {
                cursor += buffer.length;
            } else if (event.code === "ArrowUp") {
                cursor -=
                    buffer.slice(0, cursor).length -
                    buffer.slice(0, cursor).lastIndexOf("\n");
            } else if (event.code === "ArrowDown") {
                let nextLine = buffer.slice(cursor).indexOf("\n") + 1;
                cursor += (nextLine + buffer.slice(nextLine).indexOf("\n"));
            } else if (
                event.code === "Backspace" &&
                event.ctrlKey | event.metaKey
            ) {
                if (cursor != 0) {
                    for (var i = 0; i < 5; i++) {
                        buffer = removeCharAtIndex(buffer, cursor - 1);
                        cursor -= 1;
                    }
                }
            } else if (event.code === "Backspace") {
                if (cursor != 0) {
                    buffer = removeCharAtIndex(buffer, cursor - 1);
                    cursor -= 1;
                }
            } else if (event.code === "Enter") {
                buffer = insertString(buffer, cursor, "\n");
                cursor += 1;
            } else if (event.code === "Tab") {
                buffer = insertString(buffer, cursor, "    ");
                cursor += 4;
            } else if (event.code === "KeyZ" && event.ctrlKey | event.metaKey) {
                let back = history.pop();
                buffer = back == undefined ? buffer : back;
                is_back = true;
            } else if (event.code === "KeyV" && event.ctrlKey | event.metaKey) {
                navigator.clipboard.readText().then((text) => {
                    buffer = insertString(buffer, cursor, text);
                    cursor += text.length;
                    updateEditor();
                });
            } else if (event.code === "KeyC" && event.ctrlKey | event.metaKey) {
                console.log(window.getSelection().toString());
                navigator.clipboard.writeText(window.getSelection().toString());
            } else if (
                event.code === "ShiftLeft" ||
                event.code === "ShiftRight" ||
                event.code === "MetaLeft" ||
                event.code === "MetaRight" ||
                event.code === "ControlLeft" ||
                event.code === "ControlRight" ||
                event.code === "Escape" ||
                event.code === "AltLeft"||
                 event.code === "AltRight"
            ) {
                // No processing
            } else {
                if (event.shiftKey) {
                    buffer = insertString(
                        buffer,
                        cursor,
                        event.key.toUpperCase(),
                    );
                } else {
                    buffer = insertString(buffer, cursor, event.key);
                }
                cursor += 1;
            }

            if (cursor > buffer.length) {
                cursor = buffer.length;
            }
            if (cursor < 0) {
                cursor = 0;
            }

            updateEditor();
            if (!is_back) {
                history.push(buffer);
            }
        });

        document.addEventListener("DOMContentLoaded", updateEditor);
    </script>

    <style>
        body {
            padding: 1vh;
            user-select: none;
            font-family: monospace;
            background-color: whitesmoke;
            color: black;
            height: 100vh;
        }

        #cursor {
            color: blue;
        }

        .line {
            padding: 0;
            background-color: white;
            border-bottom: 1px solid whitesmoke;
        }

        .ln {
            color: whitesmoke;
        }

        #editor {
            user-select: text;
            overflow: scroll;
            background-color: white;
            color: black;
            height: 75vh;
        }
    </style>
</html>
